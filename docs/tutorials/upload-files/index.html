<!DOCTYPE html><html class="initial"><head><title>Upload files - server.js</title><meta property="og:title" content="Upload files - server.js"/><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="keywords" content="server, javascript, js, node.js, library, html, html5, express"><meta name="description" content="Learn how to allow users to upload files that live through server restarts."/><meta property="og:description" content="Learn how to allow users to upload files that live through server restarts."/><link rel="shortcut icon" type="image/png" href="/img/logo.png"><meta property="og:url" content="http://serverjs.io/"><meta property="og:image" content="https://serverjs.io/img/code.png"><link href="/assets/style.min.css" rel="stylesheet"></head><body id="top"><div class="width-1100"></div><nav><a class="brand" href="/"><img class="logo" src="/img/logo.svg" alt="logo"><span class="text">server.js</span></a><input class="show" id="bmenu" type="checkbox"><label class="burger pseudo button switch" for="bmenu">menu</label><div class="menu"><a class="pseudo button" href="https://medium.com/server-for-node-js" target="_blank">Blog</a><a class="pseudo button" href="https://github.com/franciscop/server" target="_blank">Github</a><a class="pseudo button" href="/tutorials">Tutorials</a><a class="button" href="/documentation">Documentation</a></div></nav><article class="tutorial"><div class="flex"><section class="toc"><h2><a href="/tutorials/#top">Tutorials</a></h2><ul><li><label class="more"></label><a href="/tutorials/getting-started/">Getting started</a><ul><li><a href="/tutorials/getting-started/#install-node-js">Install Node.js</a></li><li><a href="/tutorials/getting-started/#create-your-project">Create your project</a></li><li><a href="/tutorials/getting-started/#initialize-git-and-npm">Initialize Git and npm</a></li><li><a href="/tutorials/getting-started/#make-awesome-things-">Make awesome things!</a></li></ul></li><li><label class="more"></label><a href="/tutorials/sessions-production/">Session in production</a><ul><li><a href="/tutorials/sessions-production/#secret">Secret</a></li><li><a href="/tutorials/sessions-production/#storage">Storage</a></li></ul></li><li><label class="more"></label><a href="/tutorials/upload-files/">Upload files</a><ul><li><a href="/tutorials/upload-files/#installation">Installation</a></li><li><a href="/tutorials/upload-files/#interface">Interface</a></li><li><a href="/tutorials/upload-files/#uploading-user-files">Uploading user files</a></li><li><a href="/tutorials/upload-files/#database">Database</a></li><li><a href="/tutorials/upload-files/#other-vendors">Other vendors</a></li><li><a href="/tutorials/upload-files/#secure-images">Secure images</a></li><li><a href="/tutorials/upload-files/#resize-images">Resize images</a></li></ul></li><li><label class="more"></label><a href="/tutorials/spreadsheet/">Spreadsheet database</a><ul><li><a href="/tutorials/spreadsheet/#create-a-spreadsheet">Create a spreadsheet</a></li><li><a href="/tutorials/spreadsheet/#installation">Installation</a></li><li><a href="/tutorials/spreadsheet/#back-end-with-server-js">Back-end with server.js</a></li><li><a href="/tutorials/spreadsheet/#front-end">Front-end</a></li></ul></li><li><label class="more"></label><a href="/tutorials/todo/">TO-DO list</a><ul><li><a href="/tutorials/todo/#install-dependencies">Install dependencies</a></li><li><a href="/tutorials/todo/#code-organization">Code organization</a></li><li><a href="/tutorials/todo/#rest-api">REST API</a></li><li><a href="/tutorials/todo/#database">Database</a></li><li><a href="/tutorials/todo/#todos-logic">Todos logic</a></li><li><a href="/tutorials/todo/#testing">Testing</a></li></ul></li><li><label class="more"></label><a href="/tutorials/chat/">Real-time chat</a><ul><li><a href="/tutorials/chat/#user-interface">User Interface</a></li><li><a href="/tutorials/chat/#choose-a-username">Choose a username</a></li><li><a href="/tutorials/chat/#sending-messages">Sending messages</a></li><li><a href="/tutorials/chat/#server-handling">Server handling</a></li><li><a href="/tutorials/chat/#user-x-joined">User X joined</a></li><li><a href="/tutorials/chat/#upload-to-heroku">Upload to Heroku</a></li><li><a href="/tutorials/chat/#xss-protection">XSS Protection</a></li></ul></li></ul></section><div class="main"><div>
  <strong>
    <a class="button source" href="https://github.com/franciscop/server-tutorial-upload">Source code</a>
  </strong>
</div>

<h1 id="upload-files">Upload files</h1>
<p>On the old days (for the web) you had your own server with permanent storage, so any file that you wrote into your filesystem would persist there. But now if you edit a file with <code>fs</code> it will be destroyed with a server restart/relaunch.</p>
<p>For persistence we are going to use Cloudinary for images, and MongoDB with Mongoose for storing the metadata in a database. We will also use time-ago and Picnic CSS for making the interface easier. Finally I&#39;ll share some alternatives.</p>
<blockquote>
<p>Feel <a href="https://github.com/franciscop/server/issues/">free to open an issue</a> if you get lost or get an error you cannot fix at any point during this tutorial.</p>
</blockquote>
<h2 id="installation">Installation</h2>
<p>Head over <a href="https://cloudinary.com/">to Cloudinary website</a> and create a new account with &quot;Sign up for Free&quot;:</p>
<p><a href="https://cloudinary.com/"><img src="./img/signup.png" alt="Cloudinary Signup"></a></p>
<p>You can skip the setup without any problem <strong>but you have to confirm the email</strong> for it to work. Afterwards your account is ready to go! Have a look <a href="https://cloudinary.com/documentation/node_integration">at the full documentation for Node.js</a>, but we will be using the very basics in this tutorial.</p>
<p>You will also need to <a href="https://docs.mongodb.com/manual/installation/">install and run MongoDB locally</a>. Make sure that it is installed correctly by running <code>mongod --version</code>.</p>
<p>With those dependencies out of the way and after <a href="https://serverjs.io/tutorials/getting-started/">getting started</a> we install server.js and the packages we&#39;ll be using:</p>
<pre><code class="lang-js">npm install server cloudinary mongoose time-ago
</code></pre>
<p>Since we are <a href="https://serverjs.io/documentation/options/#environment">handling our secrets</a> correctly (right?), we edit our <code>.env</code> to add:</p>
<pre><code class="lang-bash"># .env
# ...

# Your personal information and secrets, available on your Cloudinary dashboard
CLOUDINARY_CLOUD=█████████   
CLOUDINARY_KEY=██████████████
CLOUDINARY_SECRET=████████████████████████████

# Let&#39;s stick to a local one so far
MONGODB_URI=mongodb://localhost/image
</code></pre>
<p>We will have <a href="https://github.com/franciscop/server-tutorial-upload">this file structure in the repository</a>:</p>
<ul>
<li><code>views</code>: folder for our views.<ul>
<li><code>index.hbs</code>: the main view with our gallery.</li>
</ul>
</li>
<li><code>.env</code>: where we store our secrets.</li>
<li><code>.gitignore</code>: tell git what files to ignore, such as node_modules.</li>
<li><code>image.js</code>: the model for saving and retrieving images from the DB.</li>
<li><code>index.js</code>: entry point with our routes and init script.</li>
<li><code>LICENSE</code>: this project is MIT &lt;3</li>
<li><code>package-lock.json</code> and <code>package.json</code>: npm info and dependencies.</li>
<li><code>upload-all.js</code>: the middleware that will handle file uploads.</li>
</ul>
<h2 id="interface">Interface</h2>
<p>Our interface is going to be a simple text field and a <code>file</code> input. We&#39;ll use <a href="https://picnicss.com/documentation#dropimage">Picnic CSS&#39; Dropimage</a> to make it look like this:</p>
<p><img src="./img/upload-gallery.png" alt="Upload Gallery"></p>
<p>Since the objective of this tutorial is <em>not</em> to learn how to the interface, just <a href="https://github.com/franciscop/server-tutorial-upload/blob/master/views/index.hbs">put the code</a> in <code>views/index.hbs</code>:</p>
<pre><code class="lang-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;title&gt;File Upload&lt;/title&gt;
    &lt;link href=&quot;https://unpkg.com/picnic&quot; rel=&quot;stylesheet&quot;&gt;
    &lt;style&gt;
      body { width: 90%; margin: 0 auto; max-width: 900px; }
      form { position: sticky; top: 0; }
      input, label, button { display: block; margin: .6em 0; width: 100%; }
      .title { margin-top: 0; }
      .avatar { padding-bottom: 100%; }
    &lt;/style&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div class=&quot;flex four&quot;&gt;
      &lt;div&gt;
        &lt;!-- NOTE: enctype is VERY important here! --&gt;
        &lt;form method=&quot;POST&quot; action=&quot;/&quot; enctype=&quot;multipart/form-data&quot;&gt;
          &lt;h2&gt;Upload&lt;/h2&gt;
          &lt;input type=&quot;hidden&quot; name=&quot;_csrf&quot; value=&quot;{{csrf}}&quot;&gt;
          &lt;input class=&quot;title&quot; name=&quot;title&quot; placeholder=&quot;Title for the image&quot; autofocus&gt;
          &lt;label class=&quot;dropimage avatar&quot;&gt;
            &lt;input name=&quot;src&quot; title=&quot;Drop image or click me&quot; type=&quot;file&quot;&gt;
          &lt;/label&gt;
          &lt;button&gt;Upload&lt;/button&gt;
        &lt;/form&gt;
      &lt;/div&gt;

      &lt;div class=&quot;three-fourth&quot;&gt;
        &lt;h2&gt;Image Gallery&lt;/h2&gt;
        &lt;div class=&quot;flex three&quot;&gt;
          {{#each pictures}}
            &lt;div&gt;
              &lt;div class=&quot;card&quot;&gt;
                &lt;header&gt;{{this.title}}&lt;/header&gt;
                &lt;img src=&quot;{{this.src}}&quot;&gt;
                &lt;footer&gt;{{this.time}}&lt;/footer&gt;
              &lt;/div&gt;
            &lt;/div&gt;
          {{/each}}
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;script&gt;
      [].forEach.call(document.querySelectorAll(&#39;.dropimage&#39;), function(img){
        img.onchange = function(e){
          var inputfile = this, reader = new FileReader();
          reader.onloadend = function(){
            inputfile.style[&#39;background-image&#39;] = &#39;url(&#39;+reader.result+&#39;)&#39;;
          }
          reader.readAsDataURL(e.target.files[0]);
        }
      });
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>Just a couple of notes on this:</p>
<ul>
<li>Make sure that the <code>&lt;form&gt;</code> element has the attribute <code>enctype</code> properly set to <code>multipart/form-data</code> as shown above.</li>
<li>Add <a href="https://serverjs.io/documentation/router/#csrf-token">the field for the CSRF token</a> or just <a href="https://serverjs.io/documentation/options/#security">disable it</a> since we are not using sessions.</li>
</ul>
<h2 id="uploading-user-files">Uploading user files</h2>
<p>Now we get to the fun part, using server.js to actually upload the pictures. Let&#39;s say we want to upload <strong>every</strong> picture that gets uploaded to our site automatically. Our entry point has two routes: the homepage rendering all the images and the handler for storing the images into the database. We are also including a middleware that will automatically upload the image to Cloudinary:</p>
<pre><code class="lang-js">const server = require(&#39;server&#39;);
const { get, post, error } = server.router;
const { render, redirect, status } = server.reply;
const uploadAll = require(&#39;./upload-all&#39;);
const Image = require(&#39;./image&#39;);

// Render the homepage with all pictures from the DB
const renderHome = async ctx =&gt; {
  const pictures = await Image.find().sort(&#39;-_id&#39;).exec();
  return render(&#39;index.hbs&#39;, { pictures });
};

// Store the posted body, which has the same props as the DB
const saveToDatabase = async ({ data }) =&gt; {
  await new Image(data).save();
};

// Load the middleware, the two routes and launch the server
server(uploadAll, [
  get(&#39;/&#39;, renderHome),
  post(&#39;/&#39;, saveToDatabase, ctx =&gt; redirect(&#39;/&#39;)),
  error(ctx =&gt; status(500).send(ctx.error.message))
]);
</code></pre>
<p>Then we write the actual code for the middleware that will upload the pictures. We are going to upload the file from <code>ctx.files</code> and then put those keys into <code>ctx.data</code>:</p>
<pre><code class="lang-js">// First configure Cloudinary:
const cloudinary = require(&#39;cloudinary&#39;);

// Set-up the configuration from the environment variables
cloudinary.config({
  cloud_name: process.env.CLOUDINARY_CLOUD,
  api_key: process.env.CLOUDINARY_KEY,
  api_secret: process.env.CLOUDINARY_SECRET
});

// Create a middleware to upload any file attached in `ctx.files`
module.exports = async ({ data, files = {} }) =&gt; {
  for (const key in files) {
    const res = await cloudinary.uploader.upload(files[key].path);
    data[key] = res.secure_url;
  }
};
</code></pre>
<p>Our file upload should be working just fine now.</p>
<h2 id="database">Database</h2>
<p>Finally let&#39;s set up the database with mongoose. Since we only need one Schema/Table and it&#39;s a simple one, we&#39;ll be setting up the whole thing in <code>image.js</code>:</p>
<pre><code class="lang-js">const mongoose = require(&#39;mongoose&#39;);
const time = require(&#39;time-ago&#39;);

// Configure the Mongoose plugin
mongoose.connect(process.env.MONGODB_URI || &#39;mongodb://localhost/image&#39;);

// Define a simple Image schema
const ImageSchema = mongoose.Schema({
  title: { type: String, required: true },
  src: { type: String, required: true },
});

// This does not exist in the DB but can be infered from the ID; we&#39;ll also
// make it pretty with &quot;time-ago&quot;. See _id =&gt; timestamp conversion:
// https://docs.mongodb.com/manual/reference/method/ObjectId.getTimestamp/
ImageSchema.virtual(&#39;time&#39;).get(function () {
  return time.ago(this._id.getTimestamp());
});

// Create and export the model so we can use the DB
module.exports = mongoose.model(&#39;Image&#39;, ImageSchema);
</code></pre>
<p>That&#39;s it, now if we run <code>node .</code> and visit <a href="http://localhost:3000/">localhost:3000</a> you&#39;ll be able to see the form and upload images. They are stored in the local database, so make sure to use a hosted database for this (in another tutorial...).</p>
<h2 id="other-vendors">Other vendors</h2>
<p>We saw a couple of very specific vendors, Cloudinary and MongoDB. As with every tutorial this is a practical one with the objective of giving you something that works by the end of it. But feel free to adapt it to your own vendor!</p>
<p>The good thing of this approach is that Cloudinary code is very well encapsulated into <code>upload-all.js</code>, so we would just have to modify this file (and the configuration on <code>.env</code>) to plug in any other vendor we want.</p>
<p>We didn&#39;t encapsulate so well the Database access, so changing our Database would imply changing the <code>index.js</code> a bit and <code>image.js</code> completely. This is something we have to consider, specially when trying and comparing different vendors.</p>
<h2 id="secure-images">Secure images</h2>
<p><strong>Exercise:</strong> make sure that your images are, aham, images. Where would you check for this? How would you check it?</p>
<p><strong>Tip:</strong> I couldn&#39;t really find a consensus on this, but make sure to find the best 2-3 ways of protecting against bad actors and either implement them all or choose the one you think is best.</p>
<h2 id="resize-images">Resize images</h2>
<p><strong>Exercise:</strong> have you tried uploading differently sized images? It gets all messed up. Use Cloudinary&#39;s image manipulation tools to crop the images and make them square.</p>
<p><strong>Tip:</strong> <a href="https://cloudinary.com/documentation/image_transformations">here is the official documentation</a> for image manipulation.</p>
<p><strong>Tip:</strong> you can do it with just CSS, but what is the advantage of actually cropping them?</p>
<h2 id="keep-reading">Keep reading</h2><p>Subscribe to our Mailchimp list to receive more tutorials when released:</p><a class="button" href="http://eepurl.com/cGRggH">Get Great Tutorials</a></div></div></article><script src="https://unpkg.com/instantclick@3.1.0-2/dist/instantclick.min.js" data-no-instant></script><script data-no-instant>InstantClick.init();</script><script src="https://unpkg.com/paperdocs@1.0.9/paperdocs.min.js" data-no-instant></script><script src="https://unpkg.com/smoothscroll-polyfill@0.4.0/dist/smoothscroll.js" data-no-instant></script><script>(() => {

  // Some super simple heuristics
  const is = {
    mobile: 'ontouchstart' in document.documentElement && window.innerWidth < 900,
    desktop: !('ontouchstart' in document.documentElement) && window.innerWidth > 900
  };

  // Add language tag to the code for print
  const regName = /lang(uage)?\-/;
  const hasName = name => regName.test(name);
  const map = { js: 'javascript', jade: 'pug' };
  [].slice.call(document.querySelectorAll('pre code')).forEach(function(pre){
    if (!regName.test(pre.className)) return;
    let name = pre.className.split(/\s+/).filter(hasName)[0].replace(regName, '');
    pre.parentNode.setAttribute('data-language', name in map ? map[name] : name);
  });

  // Display the proper part in the TOC
  const tocLinks = u('.toc [href]');
  if (is.desktop) {
    tocLinks.filter(el => {
      return u(el).attr('href').split('#')[0] === window.location.pathname;
    }).parent().addClass('active');
  }

  // Build the search
  if (u('article.documentation').length) {
    const base = el => u(el).attr('href').split('#')[0];
    const unique = (value, i, all) => all.indexOf(value) === i;
    const searchLinks = tocLinks.nodes.map(base).filter(unique);
    const all = {};
    const headings = {};
    Promise.all(searchLinks.map(link => fetch(link).then(res => res.text()).then(html => {
      u('<div>').html(html).find('article.documentation h1, article.documentation h2, article.documentation h3, article.documentation h4').each(el => {
        if (el.id) {
          if (el.nodeName === 'H1') {
            headings[`${link}`] = u(el).text();
          } else {
            headings[`${link}#${el.id}`] = u(el).text();
          }
        }
      });
      all[link] = u('<div>').html(html).find('article.documentation .main').text().toLowerCase();
    }))).then(() => {

      const search = term => {
        if (!term) {
          u('.search').removeClass('active');
          u('.searchbox').html('<ul></ul>');
          u('.toc > ul').removeClass('hidden');
          return;
        }
        u('.toc > ul').addClass('hidden');
        u('.search').addClass('active');
        const value = term.toLowerCase();
        u('.searchbox').html('<ul></ul>');
        const found = [];
        for (let link in headings) {
          if (headings[link].toLowerCase().includes(value)) {
            found.push(link.split('#')[0]);
            u('.searchbox ul').append(`<li><a href="${link}">★ ${headings[link]}</a></li>`);
          }
        }
        let extra = false;
        for (let link in all) {
          if (all[link].includes(value) && !found.includes(link)) {
            if (!extra) {
              u('.searchbox ul').append('<li class="tip">Also mentioned here:</li>');
            }
            extra = true;
            u('.searchbox ul').append(`<li><a href="${link}">${link}</a></li>`);
          }
        }
        u('.searchbox a').on('click', e => {
          u('.search').removeClass('active');
          u('.search').first().value = '';
          u('.searchbox').html('<ul></ul>');
          u('.toc > ul').removeClass('hidden');
        });
      };

      const initial = u('.search').first().value;
      if (initial) {
        search(initial);
      }
      // Autofocus only on desktop
      if (is.desktop) {
        u('.search').first().focus();
      }
      u('.search').on('input', e => {
        search(e.target.value);
      });
      u('.searchform').handle('submit', e => {
        search(u('.search').first().value);
        u('.searchbox a').first().click();
      });
    });
  }

  u('.main h2, .main h3, .main h4, .main h5').each(el => {
    const path = `${window.location.pathname.split('#')[0]}#${el.id}`;
    u(el).html(`<a href="${path}"><span class="self">#</span>${u(el).html()}</a>`);
  });



  // Remove an incorrect "get" that there was highlighted
  Prism.hooks.add('after-highlight', function(env){
    u('span.token.keyword').each(el => {
      if (el.innerHTML === 'get') {
        if (el.nextElementSibling && el.nextElementSibling.innerHTML === '(') {
          u(el).replace('<span class="token function">get</span>');
        } else {
          u(el).replace('get');
        }
      }
      if (el.innerHTML === 'delete') {
        if (el.previousElementSibling && el.previousElementSibling.innerHTML === '.') {
          u(el).replace('delete');
        }
      }
      if (el.innerHTML === 'public') u(el).replace('public');
    });
  });

  // Syntax highlighting changes vertical align. This makes it to scroll back
  // to the current hash (if any) after page load+highlight
  const hash = window.location.hash;
  if (hash && u(hash).length) {
    u(hash).scroll();
  }

  // Show more/less when clicking the chevron
  u('.toc .more').handle('click', e => {
    const container = u(e.currentTarget).closest('li');
    const child = container.find('ul').nodes[0];
    const height = container.hasClass('active') ? 0 : child.scrollHeight;
    child.style.maxHeight = height + 'px';
    container.toggleClass('active');
  });

  // Go to the appropriate part of the page when clicking an internal link
  // Manual event delegation
  u('article').on('click', e => {
    if (e.target.nodeName !== 'A') return;
    const href = u(e.target).attr('href');
    if (!href) return;
    const [url, hash] = href.split('#');

    // If it is the current URL just go to the top
    if (url === window.location.pathname && !hash) {
      e.preventDefault();
      u('body').scroll();
      history.replaceState(null, null, window.location.pathname);
      return;
    }

    // If it is an internal link go to that part
    if ((!url || url === window.location.pathname) && u('#' + hash).length) {
      e.preventDefault();
      u('#' + hash).scroll();
      history.replaceState(null, null, '#' + hash);
    }
  });



  // Google analytics
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63739359-2', 'auto');
  ga('send', 'pageview');


  // Hopefully avoid email scrapping
  setTimeout(function() {
    u('a.email').attr('href', 'mailto:public' + '@francisco.i' + 'o?subject=server.js');
  }, 2000);
})();
</script></body></html>